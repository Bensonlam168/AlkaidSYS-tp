# 数据库演进与迁移策略

## 1. 背景与目标

本设计文档用于规范 AlkaidSYS 平台在 **数据库 Schema 演进与数据迁移** 方面的整体策略，确保：

1. 结构变更对线上业务影响可控、可回滚；
2. 低代码 SchemaBuilder 与手写迁移脚本协同工作，而不是彼此冲突；
3. 多租户、多站点场景下的数据隔离与一致性得到保障；
4. 迁移过程可审计、可自动化，便于持续演进。

## 2. 适用范围与术语

- **数据库演进（Database Evolution）**：随需求变更逐步调整数据库结构和约束的过程。
- **迁移（Migration）**：一次具体的 Schema/Data 变更操作的脚本化描述与执行单元。
- **运行时 DDL**：由低代码引擎在运行时发起的表结构变更（开发/测试环境为主）。
- **生产迁移窗口**：在生产环境执行 DDL/DML 迁移脚本的受控时间段。

适用范围：MySQL 8 为主库；所有业务表（含低代码业务表、工作流表、审计表等）。

## 3. 总体原则

1. **安全优先**：禁止直接在生产环境控制台执行 ad-hoc DDL，所有变更必须通过迁移脚本+评审。
2. **可回滚**：每个迁移必须尽可能提供回滚方案（drop/rename/restore 等），或说明不可回滚的原因与补救手段。
3. **可审计**：迁移脚本、评审记录、执行记录需落盘（Git + 日志），支持事后追踪。
4. **环境隔离**：开发/测试/预发/生产的迁移在不同数据库和流水线中执行，不共享物理实例。
5. **与低代码协同**：低代码 SchemaBuilder 在开发/测试可以直接 DDL，生产环境只生成“迁移建议”，由 DBA/研发审核后以脚本方式执行。

## 4. 变更类型与风险分级

- **低风险变更**（一般允许在线执行）：
  - 新增允许为 NULL 或带默认值的列；
  - 新增非唯一索引（在业务低峰期执行）；
  - 新增小表（行数有限、无历史数据）。
- **中风险变更**（需评估&演练）：
  - 修改列类型但保证兼容（如 `INT` → `BIGINT`）；
  - 新增唯一约束 / 唯一索引；
  - 新增/调整外键约束。
- **高风险变更**（必须走严格评审与演练）：
  - 删除列、删除表；
  - 对大表重建索引或调整主键；
  - 大规模数据清理/历史归档。

不同风险级别，对应不同的审批人和演练要求，应在实施阶段结合实际项目细化。

## 5. 迁移工作流（从需求到上线）

1. **提出需求**：产品/架构/研发提出需要调整的数据模型或索引；
2. **设计方案**：由数据建模负责人编写迁移设计说明，明确变更类型、影响面、风险级别；
3. **生成迁移脚本**：
   - 低代码 SchemaBuilder 在开发环境可直接生成/应用 DDL；
   - 生产环境由研发手写或由工具生成 SQL 脚本，进入代码仓库（如 `database/migrations` 目录）。
4. **评审与演练**：
   - 在测试/预发环境执行迁移脚本，验证功能与性能影响；
   - 记录执行时间、锁表情况、回滚可行性。
5. **生产执行**：
   - 在约定的迁移窗口由运维/DBA 执行；
   - 同步记录执行日志与结果（成功/失败/部分失败）。
6. **回滚与善后**：
   - 如迁移失败，根据预案执行回滚脚本或人工修复；
   - 更新文档与监控阈值（例如针对新索引的 QPS/延迟）。

## 6. 与低代码 SchemaBuilder 的协同

低代码引擎通过 `SchemaBuilder` 提供“运行时建表/改表”能力，需要与本策略协调：

- **开发/测试环境**：
  - 允许 SchemaBuilder 直接在数据库执行 DDL，以提升迭代效率；
  - 要求同步生成对应的“迁移脚本草案”，提交到代码仓库，避免“只存在于测试库”的结构。
- **生产环境**：
  - 禁止 SchemaBuilder 直接连接生产库执行 DDL；
  - 只允许其生成迁移脚本候选（或结构 diff 报告），交由 DBA/研发审核后纳入统一迁移流水线；
  - 对于高频动态建表场景（如每租户独立表），必须在架构设计层面单独评估，不作为默认能力开放。

## 7. 运行时 DDL 环境防护（T1-DDL-GUARD）

为避免低代码等运行时 DDL 能力误入生产环境，执行以下环境策略：

- **环境白名单 + 开关（混合策略）**：
  - 仅当 `APP_ENV` 位于白名单（如 `dev/local/testing`）**且** `ALLOW_RUNTIME_DDL=true` 时，才允许运行时 DDL 真实执行；
  - 即使误在生产环境打开 `ALLOW_RUNTIME_DDL`，由于 `APP_ENV` 不在白名单内，仍会被拦截。
- **生产环境行为**：
  - `APP_ENV=production` 时，SchemaBuilder 不直接执行 DDL，而是通过统一 guard 抛出 `code=5003`、HTTP 403 的错误响应；
  - 运维应通过独立的迁移脚本流水线完成结构变更。
- **审计与追踪**：
  - 所有运行时 DDL 尝试（成功/失败）都记录 `env/operation/table/trace_id` 等关键信息，便于审计；
  - Trace 中间件产生的 `trace_id` 将贯穿请求链路与 DDL 日志。

上述策略由 `Infrastructure\\Schema\\SchemaBuilder` 统一实现，通过环境变量 `SCHEMA_RUNTIME_DDL_ALLOWED_ENVS` 与 `ALLOW_RUNTIME_DDL` 进行配置。

## 7. 多租户场景下的特别注意

1. 所有新建业务表必须包含 `tenant_id`、`site_id` 字段以及组合索引 `idx_tenant_site (tenant_id, site_id)`；
2. 表结构变更不得破坏现有租户数据的隔离性，例如：
   - 禁止将多租户表拆成单租户表而不迁移/隔离历史数据；
   - 对分区/分表策略的调整必须有清晰的数据迁移路径与回退方案。
3. 迁移脚本中应避免使用硬编码的租户 ID，尽量按照全量数据扫描+条件过滤的方式实现。

## 8. 与其他设计文档的关系

- 与 `03-data-layer/09-database-design.md`：本文件在其基础上补充“如何变更”的过程视角；
- 与 `09-lowcode-framework/42-lowcode-data-modeling.md`：约束了运行时 DDL 在不同环境下的边界；
- 与 `09-lowcode-framework/51-form-collection-workflow-end-to-end.md`：确保表单/工作流相关表结构变更遵循统一迁移机制；
- 与 `04-security-performance/11-security-design.md`：在数据安全维度（备份、审计）上形成配合。

后续如有新的数据库引擎或分布式存储引入，应在本文件基础上扩展对应章节。
