# 数据演进蓝皮书（低代码 × 迁移 × 多租户）

## 📋 文档信息

| 项目 | 内容 |
|------|------|
| **文档名称** | 数据演进蓝皮书（低代码 × 迁移 × 多租户） |
| **文档版本** | v1.0 |
| **创建日期** | 2025-11-18 |
| **关联文档** | 01-architecture-design/04-multi-tenant-design.md、08-low-code-design.md、03-data-layer/09-database-design.md、11-database-evolution-and-migration-strategy.md、12-multi-tenant-data-model-spec.md |

## 🎯 设计目标

1. 给出一份从“需求 → 设计 → 低代码配置 → 迁移脚本 → 多租户落地 → 监控与回滚”的数据演进全景图；
2. 协调多租户数据建模规范、数据库演进策略与低代码 SchemaBuilder 的职责边界；
3. 提供典型场景的推荐流程与注意事项。

## 1. 角色与职责

- **产品 / 业务负责人**：提出数据结构变更需求，确认业务约束与兼容性；
- **架构师 / 数据建模负责人**：根据多租户规范评估建模方案；
- **低代码配置者**：在 SchemaBuilder 中调整模型 / 表单 / 流程；
- **DBA / 数据工程师**：负责迁移脚本评审、演练与执行；
- **后端开发**：实现必要的代码调整与回滚逻辑；
- **运维 / SRE**：负责监控指标与告警阈值调整。

## 2. 统一数据演进流程

1. **需求评审阶段**
   - 明确变更影响的表、字段、索引及其多租户属性（是否带 `tenant_id`/`site_id`）；
   - 参考《多租户 / 多站点数据建模规范》判断是否需要分区 / 分表调整。
2. **方案设计阶段**
   - 在 `09-database-design.md` 基础上给出“目标结构草图”；
   - 评估对共享库 / 独立库 / 混合模式下不同租户的影响；
   - 在 `11-database-evolution-and-migration-strategy.md` 视角下确定风险级别与回滚策略。
3. **低代码配置阶段（如适用）**
   - 通过 SchemaBuilder 更新模型定义，生成迁移脚本草案；
   - 确保生成的 Schema 符合 `12-multi-tenant-data-model-spec.md` 的字段与索引约束。
4. **迁移脚本编写与评审阶段**
   - 在代码仓 `database/migrations` 中维护最终迁移脚本；
   - 由 DBA / 架构师联合评审：性能影响、多租户隔离性、回滚方案；
5. **演练与灰度阶段**
   - 在测试 / 预发环境按生产规模数据尽量接近的条件下演练；
   - 记录执行时间、锁表情况和监控指标变化；
6. **生产执行与回滚准备**
   - 在约定迁移窗口内执行，严格记录日志与 `trace_id`；
   - 预先准备好回滚脚本或补救方案（如表重命名 + 备份恢复）。

## 3. 典型场景建议

1. **为多租户共享表新增字段**
   - 优先选择“允许 NULL 或带默认值”的新增字段，降低风险等级；
   - 避免一次性对超大表执行复杂 DDL（如修改列类型 + 调整主键），必要时拆分多个迁移。
2. **租户从共享库迁移到独立库**
   - 按《多租户架构设计》中的混合模式策略，设计专门的迁移脚本：
     - 导出租户相关数据；
     - 在新库中重建结构并导入数据；
     - 切换连接配置并在短时间内双写 / 校验；
   - 提前规划回退路径（如保留共享库只读副本一段时间）。
3. **低代码生成的新业务模块上线**
   - 开发 / 测试环境允许直接 DDL，生产环境仅提交迁移脚本；
   - 对涉及大表或高频访问表的变更，必须经过人工评审与预发压测。

## 4. 文档关系与后续演进

- 本文档提供“蓝皮书式”的全景流程，不替代任何一份详细设计文档；
- 具体规则与实现细节以以下文档为准：
  - 多租户建模：`12-multi-tenant-data-model-spec.md`；
  - 数据库设计与演进：`09-database-design.md`、`11-database-evolution-and-migration-strategy.md`；
  - 低代码设计：`01-architecture-design/08-low-code-design.md`；
- 后续如引入新的存储引擎或多地域多活方案，应在相应文档中扩展并在此处补充流程节点。
