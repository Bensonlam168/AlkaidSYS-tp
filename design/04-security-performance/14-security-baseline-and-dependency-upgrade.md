# 安全基线与依赖升级策略

## 1. 背景与目标

AlkaidSYS 平台在安全设计上依赖多种第三方组件（如 JWT、Casbin、ExpressionLanguage 等）。本文件旨在：

1. 定义平台安全基线（最小安全要求）；
2. 规范安全相关依赖的版本管理与升级流程；
3. 定义安全漏洞响应与紧急补丁流程；
4. 确保依赖升级过程中对业务影响可控、可回滚。

## 2. 适用范围

- 后端安全相关依赖：
  - `firebase/php-jwt`：用户认证与 Token 签发/验证；
  - `php-casbin/php-casbin`：RBAC/ABAC 授权；
  - `symfony/expression-language`：低代码/工作流表达式执行；
  - 其他如 `symfony/validator`、`guzzlehttp/guzzle`、`monolog/monolog` 等基础组件。
- 本策略适用于所有环境（dev/test/stage/prod），但在执行节奏和审批流程上可有所区别。

## 3. 安全基线要求

1. **依赖来源**：
   - 所有依赖必须来自可信官方源（Packagist 等），禁止使用来历不明的镜像或 zip 包。
2. **版本约束**：
   - 在 `03-PROJECT-DEPENDENCIES.md` 中统一记录版本范围（例如 `^6.0`），作为依赖的“单一真相源”；
   - 业务代码中禁止显式依赖某个具体 patch 版本。
3. **敏感信息保护**：
   - JWT 密钥、数据库密码等敏感配置不得提交到代码仓库，需通过环境变量或安全配置中心管理；
   - 日志中不得输出完整 Token 或敏感字段，仅记录必要的标识信息（如 userId、traceId）。
4. **运行时安全控制**：
   - ExpressionLanguage 执行上下文必须受限，禁止访问任意全局变量或危险函数；
   - Casbin 的策略变更需有审计日志，并限制可修改策略的管理端接口。

## 4. 依赖升级策略

1. **常规升级节奏**：
   - 建议每季度进行一次“安全依赖巡检”，对 JWT/Casbin/ExpressionLanguage 等关键组件执行 minor/patch 级升级；
   - 对于仅修复 bug 而无破坏性变更的 patch 版本，可在测试验证通过后快速合入。
2. **升级流程**：
   1）安全或架构负责人关注官方发布渠道（GitHub Release、CVE 公告等）；
   2）在 `03-PROJECT-DEPENDENCIES.md` 中更新目标版本范围；
   3）在独立分支中执行依赖升级并运行完整测试与基础性能回归；
   4）在测试/预发环境灰度验证后，按变更管理流程合入主干并部署到生产。
3. **兼容性评估**：
   - 对存在破坏性变更的版本，需在设计层面评估影响（API 变更、配置变更等），并在相关设计文档中补充说明；
   - 必要时在代码中引入适配层，平滑迁移到新版本。

## 5. 安全漏洞响应流程

1. **漏洞发现**：
   - 通过官方公告、社区反馈或内部安全扫描发现安全漏洞；
2. **影响评估**：
   - 安全部门/架构师评估漏洞对当前系统的影响范围和严重程度；
3. **制定修复方案**：
   - 优先选择官方修复版本；
   - 如暂无法升级到安全版本，则评估是否可通过配置/网络策略等方式临时缓解；
4. **紧急发布**：
   - 根据严重程度确定是否走紧急发布流程（加急测试+灰度+回滚预案）；
5. **复盘与文档更新**：
   - 漏洞处理完成后，更新相关设计文档和运维手册，总结教训与改进点。

## 6. 与其他设计文档的关系

- 与 `04-security-performance/11-security-design.md`：本文件在其基础上具体化“如何管理安全依赖及其升级”；
- 与 `05-deployment-testing/14-deployment-guide.md`：部署流程中应显式纳入“安全依赖升级任务”的步骤；
- 与 `03-PROJECT-DEPENDENCIES.md`：作为依赖版本的单一真相源，与本策略形成闭环。

