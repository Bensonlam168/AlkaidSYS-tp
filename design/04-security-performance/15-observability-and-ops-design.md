# 可观测性与运维设计

## 1. 目标

本设计文档用于定义 AlkaidSYS 平台的 **可观测性（Observability）与运维支持能力**，确保：

1. 关键请求与任务链路可追踪；
2. 故障可快速定位（哪一租户、哪一服务、哪一节点）；
3. 性能瓶颈和容量风险可提前预警；
4. 对低代码与工作流执行链路有专门的监控与诊断视角。

## 2. 范围

- 后端服务（包括核心业务、低代码引擎、工作流引擎）；
- Swoole/ThinkPHP 常驻进程环境；
- 数据库、缓存、消息队列等基础设施；
- 前后端交互层面的关键指标（如 API 错误率、延迟）。

## 3. 日志规范

1. **结构化日志**：
   - 统一使用 JSON 或键值对形式输出关键字段，便于后续集中检索与分析；
   - 建议字段：timestamp、level、service、traceId、spanId、tenantId、siteId、userId、route、errorCode、message 等。
2. **日志分级**：
   - DEBUG：开发调试使用，生产环境默认关闭；
   - INFO：关键业务流程状态，如工作流节点进入/完成；
   - WARN：可疑但未影响业务的异常，如重试成功；
   - ERROR：导致当前请求/任务失败的错误；
   - FATAL：影响系统整体可用性的严重故障。
3. **敏感信息控制**：
   - 不在日志中输出密码、Token、身份证号等敏感数据；
   - 如需排查问题，可通过 traceId 结合数据库脱敏查询。

## 4. 指标（Metrics）

建议至少覆盖以下类别：

1. **可用性指标**：
   - 接口成功率/错误率（按服务、接口、租户维度聚合）；
   - 工作流节点执行成功率/失败率；
2. **性能指标**：
   - 请求延迟 P50/P90/P99；
   - 工作流执行耗时（整体与单节点）；
   - 队列消费延迟、队列长度；
3. **资源指标**：
   - Swoole 工作进程的 CPU/内存使用率；
   - 数据库连接数、慢查询数量；
   - Redis 命中率、key 数量等。

## 5. Tracing 设计

1. **TraceId 贯穿**：
   - 在入口（网关或 HTTP 中间件）生成 traceId，并通过请求头 / 上下文在服务间传递；
   - 日志与指标中均携带 traceId，支持跨组件跳转。
2. **关键链路埋点**：
   - 低代码表单提交 → Collection 写入 → 领域事件 → 工作流触发 → 节点执行 → 数据回写；
   - 每个阶段至少记录开始/结束时间与结果状态。
3. **采样策略**：
   - 对于高 QPS 接口可采用动态采样，仅保存慢请求或错误链路的完整 trace；
   - 对工作流执行可提高采样比例，以便问题分析。

## 6. 告警策略

1. **告警源**：
   - 指标阈值告警（如错误率、延迟、队列长度等超阈）；
   - 日志模式匹配告警（如出现特定错误码或关键字）；
   - 心跳/存活检查失败告警。
2. **分级处理**：
   - P0：影响大面积用户或核心业务中断，需 7x24 小时响应该级别告警；
   - P1：局部功能异常或单租户受影响，在工作时间内优先处理；
   - P2：可容忍的降级或单点故障，纳入排期处理。
3. **告警抑制与合并**：
   - 防止同一根因导致的告警风暴，通过时间窗口与聚合策略压缩告警量；
   - 关键告警应关联 Runbook 链接，指导值班人员快速处理。

## 7. 与其他文档的关系

- 与 `04-security-performance/13-monitoring-logging.md`：如已存在监控/日志文档，本文件在其上补充“可观测性体系”的整体视角；
- 与 `09-lowcode-framework/51-form-collection-workflow-end-to-end.md`：对其描述的端到端链路增加可观测性要求；
- 与 `05-deployment-testing/14-deployment-guide.md`：确保部署流水线中包含监控与告警配置的同步步骤。

