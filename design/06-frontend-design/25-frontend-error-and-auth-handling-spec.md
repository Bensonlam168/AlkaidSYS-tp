# 前端错误与权限处理规范

## 📋 文档信息

| 项目 | 内容 |
|------|------|
| **文档名称** | 前端错误与权限处理规范 |
| **文档版本** | v1.0 |
| **创建日期** | 2025-11-18 |
| **关联文档** | 01-architecture-design/07-multi-terminal-design.md、06-frontend-design/17-admin-frontend-design.md、18-web-frontend-design.md、19-mobile-frontend-design.md |

## 🎯 设计目标

1. 统一 Admin/Web/移动端 对后端错误与权限问题的处理方式；
2. 提高用户体验：清晰、友好的错误提示与登录态处理；
3. 降低前后端沟通成本：使用统一的响应结构和错误码语义。

## 1. 后端统一响应结构

所有 HTTP API（含 Admin/Web/UniApp）统一使用如下响应结构：

```json
{
  "code": 0,
  "message": "OK",
  "data": {},
  "trace_id": "可选，用于排错"
}
```

- `code`: 业务状态码，`0` 表示成功，非 `0` 表示失败；
- `message`: 人类可读的提示文案；
- `data`: 业务数据或 `null`；
- `trace_id`: 可选，用于在日志 / APM 中快速定位请求。

HTTP 状态码与业务 `code` 的推荐映射：

| HTTP 状态码 | 业务 code 示例 | 含义 |
|-------------|----------------|------|
| 200         | 0              | 成功 |
| 400         | 1001/1002      | 参数错误、校验失败 |
| 401         | 2001           | 未登录或 Token 失效 |
| 403         | 2002           | 无访问权限 |
| 404         | 3001           | 资源不存在 |
| 429         | 4001           | 访问过于频繁（限流） |
| 500         | 5000           | 未预期服务器错误 |

## 2. 认证与权限相关错误处理

### 2.1 401 未登录 / Token 失效

统一策略：

1. 前端请求拦截器在收到 401 时：
   - 清理本地 Token / 用户信息缓存；
   - 跳转到登录页，并携带 `redirect` 参数（原始路径）；
   - 在登录页顶部展示“登录已过期，请重新登录”。
2. 若支持 Refresh Token：
   - 在第一次 401 时先尝试调用刷新接口；
   - 刷新成功则重放原请求；
   - 刷新失败再按上述流程退回登录页。

### 2.2 403 无权限

统一策略：

1. 不自动跳转登录页（说明已登录，只是权限不足）；
2. Admin/Web 统一跳转到“403 无权限”页面，包含：
   - 简短说明：“您没有访问该资源的权限”；
   - 返回首页 / 返回上一页按钮；
3. 移动端弹出 Toast：“无访问权限”，并可选择留在当前页或返回上一页。

## 3. 通用错误处理流程

在前端请求封装层（如 `@/utils/request` 或 `uni.request` 封装）中实现统一的错误处理：

1. **参数 / 校验错误（400 + code 1xxx）**
   - 使用表单级错误提示（表单校验信息），或在页面顶部显示“请检查输入内容”；
2. **资源不存在（404 + code 3001）**
   - 跳转到统一的 404 页面或在页面中展示“内容不存在或已被删除”；
3. **限流（429 + code 4001）**
   - 显示“请求过于频繁，请稍后再试”；
   - 可在 Admin 中额外显示 trace_id 以便排查；
4. **服务器错误（500 + code 5000）**
   - 显示通用错误页：“系统开小差了，请稍后重试”；
   - 将 `trace_id` 上报到错误监控系统（如 Sentry）。

## 4. 多端实现要点

1. **Admin (Vben)**：
   - 在 axios 拦截器中统一处理 401/403/非 2xx；
   - 使用 Ant Design Vue 的通知组件统一展示错误消息；
   - 使用路由守卫在进入受保护路由前检查登录态和权限。
2. **PC Web (Vue3)**：
   - 复用 Admin 的请求封装；
   - 对公共页面适当“降级显示”错误（如局部错误提示而非整页红屏）。
3. **移动端 (UniApp)**：
   - 在 `uni.request` 封装中实现相同的错误码解析逻辑；
   - 使用 Toast / Modal 提示错误，避免过多跳转；
   - 对网络错误（如断网）专门提示“当前网络不可用，请检查网络设置”。

## 5. 与后端约定

1. 后端所有接口必须返回统一结构，不允许直接抛出 HTML 错误页；
2. 与认证 / 权限相关的中间件需严格区分 401 与 403；
3. 业务错误码应在统一位置维护（如 `config/error_code.php`），前后端共享同一份映射表；
4. 日志中需记录 `trace_id` 与业务 code，便于前端反馈问题时快速排查。
