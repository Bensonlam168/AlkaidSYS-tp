# AlkaidSYS API Nginx gateway (T2-NGINX-GW skeleton)
#
# 注意：本配置为生产可用的「骨架」，并非完整生产配置。
# - 请根据实际环境（dev/stage/prod）调整域名、证书路径、后端地址等占位符。
# - upstream 端口与 `config/swoole.php` 中 HTTP 配置保持一致（默认 8080）。

# 后端 Swoole HTTP 实例（可扩展为多节点）
upstream swoole_backend {
    # dev/local 示例：单节点，Swoole 运行在 backend 容器内（docker-compose，服务名 alkaid-backend，监听 8080）
    server alkaid-backend:8080 weight=1 max_fails=3 fail_timeout=30s;

    # stage/prod 示例：多节点时请按真实 IP/主机名添加多行，例如：
    # server 10.0.1.10:8080 weight=1 max_fails=3 fail_timeout=30s;
    # server 10.0.1.11:8080 weight=1 max_fails=3 fail_timeout=30s;

    # 如在宿主机直接运行 Swoole（非 Docker），可改回：127.0.0.1:8080 或实际 IP

    # 复用后端连接，降低 TCP 握手开销
    keepalive 32;
}
# ----------------------------------------------------------------------
# Logging: JSON access log format (alkaid_api_json)
# ----------------------------------------------------------------------
log_format alkaid_api_json escape=json '{"timestamp":"$time_iso8601"'
    ',"env":"$http_x_app_env"'
    ',"trace_id":"$http_x_trace_id"'
    ',"method":"$request_method"'
    ',"path":"$uri"'
    ',"query":"$args"'
    ',"status_code":$status'
    ',"request_time":$request_time'
    ',"upstream_time":"$upstream_response_time"'
    ',"client_ip":"$remote_addr"'
    ',"user_agent":"$http_user_agent"'
    ',"user_id":"$http_x_user_id"'
    ',"tenant_id":"$http_x_tenant_id"'
    ',"site_id":"$http_x_site_id"'
    ',"rate_limited":"$sent_http_x_rate_limited"'
    '}}';



# ----------------------------------------------------------------------
# HTTP (80) 入口
# ----------------------------------------------------------------------

# dev/local 环境：直接通过 HTTP 访问，由 Nginx 反代后端 Swoole（无需证书）
server {
    listen 80;
    server_name api.alkaidsys.local;

    root /var/www/alkaid/public;
    index index.php index.html;

    access_log /var/log/nginx/alkaid_api_access.log alkaid_api_json;

    location / {
        proxy_pass http://swoole_backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 5s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
}

# 如需在 dev/local 环境直接通过 HTTP 访问（无 HTTPS），可参考：
# server {
#     listen 80;
#     server_name api.alkaidsys.local;
#
#     root /var/www/alkaid/public;
#     index index.php index.html;
#
#     location / {
#         proxy_pass http://swoole_backend;
#         proxy_http_version 1.1;
#         proxy_set_header Connection "";
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#
#         proxy_connect_timeout 5s;
#         proxy_send_timeout 30s;
#         proxy_read_timeout 30s;
#     }
# }

# ----------------------------------------------------------------------
# HTTPS (443) 入口
# ----------------------------------------------------------------------
server {
    listen 443 http2;

    # 与上方 80 端口保持一致的域名集合
    server_name
        api.alkaidsys.local
        api.test.alkaidsys.com
        api.stage.alkaidsys.com
        api.alkaidsys.com;

    # -------------------- SSL 配置（需按环境替换） --------------------
    # ⚠️ 请替换为实际证书路径（全链证书和私钥），支持多环境分机配置
    # dev/local 环境：如未准备证书，可暂时注释掉证书配置并去掉 listen 行中的 ssl 关键字
    # ssl_certificate     /etc/nginx/ssl/REPLACE_ME_fullchain.crt;
    # ssl_certificate_key /etc/nginx/ssl/REPLACE_ME_privkey.key;

    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # 根据需要开启 HSTS（仅在确认 HTTPS 部署稳定后启用）
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # ------------------------ 日志配置 ------------------------
    access_log /var/log/nginx/alkaid_api_access.log alkaid_api_json;
    error_log  /var/log/nginx/alkaid_api_error.log warn;

    # ------------------------ Gzip & 静态资源 ------------------------
    gzip on;
    gzip_min_length 1000;
    gzip_comp_level 5;
    gzip_types
        text/plain
        text/css
        application/json
        application/javascript
        application/xml
        application/xml+rss
        font/woff2
        image/svg+xml;

    # 静态资源缓存（示例：/public 下的前端静态文件）
    root /var/www/alkaid/public;
    index index.php index.html;

    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # ------------------------ API 反向代理 ------------------------
    location / {
        proxy_pass http://swoole_backend;
        proxy_http_version 1.1;

        # 连接复用与真实 IP 透传
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超时与缓冲（可按需调整）
        proxy_connect_timeout 5s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        proxy_buffering on;

        # 预留：后续可在此处增加限流、灰度、熔断等功能
        # 示例：include /etc/nginx/conf.d/alkaid.ratelimit.conf;
    }
}

