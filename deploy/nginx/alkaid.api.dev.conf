# AlkaidSYS API Nginx Gateway - Development Environment
#
# 开发环境配置：本地开发使用
# - 域名：api.alkaidsys.local
# - HTTP only (无 HTTPS)
# - 允许 localhost CORS
# - 详细日志记录

upstream swoole_backend_dev {
    server alkaid-backend:8080 weight=1 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

log_format alkaid_api_json escape=json '{"timestamp":"$time_iso8601"'
    ',"env":"dev"'
    ',"trace_id":"$http_x_trace_id"'
    ',"method":"$request_method"'
    ',"path":"$uri"'
    ',"query":"$args"'
    ',"status_code":$status'
    ',"request_time":$request_time'
    ',"upstream_time":"$upstream_response_time"'
    ',"client_ip":"$remote_addr"'
    ',"user_agent":"$http_user_agent"'
    ',"user_id":"$http_x_user_id"'
    ',"tenant_id":"$http_x_tenant_id"'
    ',"site_id":"$http_x_site_id"'
    ',"rate_limited":"$sent_http_x_rate_limited"'
    '}}';

# CORS 配置：开发环境允许所有 localhost 源
map $http_origin $cors_origin_dev {
    default "";
    "~^http://localhost(:[0-9]+)?$" $http_origin;
    "~^http://127\\.0\\.0\\.1(:[0-9]+)?$" $http_origin;
}

server {
    listen 80;
    server_name api.alkaidsys.local;

    access_log /var/log/nginx/alkaid_api_dev_access.log alkaid_api_json;
    error_log  /var/log/nginx/alkaid_api_dev_error.log debug;

    location / {
        # CORS 预检请求
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' $cors_origin_dev always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Accept, Authorization, Content-Type, X-Requested-With, X-Trace-Id, X-Tenant-ID, X-Site-ID, Accept-Language' always;
            add_header 'Access-Control-Max-Age' 86400 always;
            return 204;
        }

        # 代理到后端
        proxy_pass http://swoole_backend_dev;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 透传关键头部
        proxy_set_header X-Trace-Id $http_x_trace_id;
        proxy_set_header X-Tenant-ID $http_x_tenant_id;
        proxy_set_header X-User-ID $http_x_user_id;
        proxy_set_header X-Site-ID $http_x_site_id;

        proxy_connect_timeout 5s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
}
