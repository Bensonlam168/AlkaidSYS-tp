# Auggie Command: åˆå§‹åŒ–ä½ä»£ç ç¯å¢ƒ
# ç”¨äºå¿«é€Ÿåˆå§‹åŒ– AlkaidSYS ä½ä»£ç å¼€å‘ç¯å¢ƒ

name: lowcode-init
version: 1.0.0
description: åˆå§‹åŒ– AlkaidSYS ä½ä»£ç å¼€å‘ç¯å¢ƒï¼ŒåŒ…æ‹¬æ•°æ®åº“è¿ç§»ã€ç§å­æ•°æ®å’Œç¤ºä¾‹ Collection

# å‘½ä»¤åˆ«å
aliases:
  - lc-init
  - init-lowcode

# å‘½ä»¤å‚æ•°
parameters:
  - name: with_examples
    type: boolean
    required: false
    default: true
    description: æ˜¯å¦åˆ›å»ºç¤ºä¾‹ Collection

  - name: skip_migration
    type: boolean
    required: false
    default: false
    description: æ˜¯å¦è·³è¿‡æ•°æ®åº“è¿ç§»

# æ‰§è¡Œæ­¥éª¤
steps:
  - name: check_environment
    description: æ£€æŸ¥ç¯å¢ƒé…ç½®
    actions:
      - æ£€æŸ¥ PHP ç‰ˆæœ¬ >= 8.2
      - æ£€æŸ¥ MySQL è¿æ¥
      - æ£€æŸ¥ Redis è¿æ¥
      - æ£€æŸ¥å¿…è¦çš„ PHP æ‰©å±•
    on_error: æç¤ºç¼ºå°‘çš„ä¾èµ–å¹¶é€€å‡º

  - name: run_migrations
    description: è¿è¡Œæ•°æ®åº“è¿ç§»
    condition: skip_migration == false
    actions:
      - è¿è¡Œå‘½ä»¤ï¼šphp think migrate:run
      - åˆ›å»ºä½ä»£ç ç›¸å…³è¡¨ï¼š
        - lowcode_collections
        - lowcode_fields
        - lowcode_relationships
        - lowcode_forms
        - lowcode_workflows
    on_error: å›æ»šè¿ç§»å¹¶æç¤ºé”™è¯¯

  - name: seed_data
    description: å¡«å……åˆå§‹æ•°æ®
    actions:
      - è¿è¡Œå‘½ä»¤ï¼šphp think seed:run
      - åˆ›å»ºé»˜è®¤ç§Ÿæˆ·
      - åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·
      - åˆ›å»ºé»˜è®¤è§’è‰²å’Œæƒé™

  - name: create_examples
    description: åˆ›å»ºç¤ºä¾‹ Collection
    condition: with_examples == true
    actions:
      - åˆ›å»º Product Collectionï¼ˆå•†å“ï¼‰
        - å­—æ®µï¼šname, price, stock, status, description
      - åˆ›å»º Category Collectionï¼ˆåˆ†ç±»ï¼‰
        - å­—æ®µï¼šname, parent_id, sort_order
      - åˆ›å»º Order Collectionï¼ˆè®¢å•ï¼‰
        - å­—æ®µï¼šorder_no, user_id, total_amount, status
      - å»ºç«‹å…³ç³»ï¼š
        - Product belongsTo Category
        - Order hasMany OrderItem

  - name: setup_cache
    description: åˆå§‹åŒ–ç¼“å­˜
    actions:
      - æ¸…ç©º Redis ç¼“å­˜
      - é¢„çƒ­ Collection Schema ç¼“å­˜
      - é¢„çƒ­æƒé™ç¼“å­˜

  - name: verify_installation
    description: éªŒè¯å®‰è£…
    actions:
      - æµ‹è¯• Collection æŸ¥è¯¢
      - æµ‹è¯• API ç«¯ç‚¹
      - ç”Ÿæˆå®‰è£…æŠ¥å‘Š

# è¾“å‡ºä¿¡æ¯
outputs:
  success_message: |
    âœ… AlkaidSYS ä½ä»£ç ç¯å¢ƒåˆå§‹åŒ–æˆåŠŸï¼

    ğŸ“Š æ•°æ®åº“è¿ç§»ï¼šå·²å®Œæˆ
    ğŸ‘¤ é»˜è®¤ç®¡ç†å‘˜ï¼šadmin / admin123
    ğŸ“¦ ç¤ºä¾‹ Collectionï¼šå·²åˆ›å»º 3 ä¸ª

    ğŸš€ ä¸‹ä¸€æ­¥ï¼š
    1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼šphp think run
    2. è®¿é—®ç®¡ç†åå°ï¼šhttp://localhost:8000/admin
    3. æŸ¥çœ‹ API æ–‡æ¡£ï¼šhttp://localhost:8000/api/docs

    ğŸ“š æ–‡æ¡£ï¼š
    - ä½ä»£ç æ¡†æ¶ï¼šdesign/09-lowcode-framework/
    - API è®¾è®¡ï¼šdesign/03-data-layer/10-api-design.md
    - å¼€å‘æŒ‡å—ï¼šdesign/08-developer-guides/

  error_message: |
    âŒ åˆå§‹åŒ–å¤±è´¥ï¼

    è¯·æ£€æŸ¥ï¼š
    1. æ•°æ®åº“è¿æ¥é…ç½®ï¼ˆ.env æ–‡ä»¶ï¼‰
    2. Redis è¿æ¥é…ç½®
    3. æ–‡ä»¶æƒé™ï¼ˆruntime/ ç›®å½•ï¼‰

    è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š{error_details}

# ä½¿ç”¨ç¤ºä¾‹
examples:
  - description: å®Œæ•´åˆå§‹åŒ–ï¼ˆåŒ…å«ç¤ºä¾‹ï¼‰
    command: auggie --print "è¿è¡Œ lowcode-init å‘½ä»¤"

  - description: åˆå§‹åŒ–ä½†ä¸åˆ›å»ºç¤ºä¾‹
    command: auggie --print "è¿è¡Œ lowcode-init å‘½ä»¤ï¼Œwith_examples=false"

  - description: è·³è¿‡æ•°æ®åº“è¿ç§»
    command: auggie --print "è¿è¡Œ lowcode-init å‘½ä»¤ï¼Œskip_migration=true"

# ä¾èµ–æ£€æŸ¥
dependencies:
  - php: ">=8.2"
  - mysql: ">=8.0"
  - redis: ">=6.0"
  - composer_packages:
      - topthink/framework: "^8.0"
      - topthink/think-migration: "^3.1"

# å›æ»šæ”¯æŒ
rollback:
  enabled: true
  steps:
    - å›æ»šæ•°æ®åº“è¿ç§»ï¼šphp think migrate:rollback
    - æ¸…ç©ºç¼“å­˜ï¼šphp think cache:clear
    - åˆ é™¤ç¤ºä¾‹æ•°æ®
