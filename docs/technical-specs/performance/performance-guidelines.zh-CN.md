# 性能与扩展性规范

## 1. 范围与目标

本规范用于约束 AlkaidSYS 的性能与扩展性设计，是在 API、安全、数据库与部署规范基础上的**补充性权威规范**。

## 2. 通用原则

- 性能优化 **必须** 关注端到端的用户感知延迟与吞吐，而不仅是局部微基准。
- 任何优化 **不得** 以牺牲正确性、安全性或可维护性为代价。

## 3. 数据库性能

- 针对租户级数据的查询 **必须** 使用包含 `tenant_id`（及必要时 `site_id`）的索引。
- N+1 查询模式 **必须** 通过预加载、连接或批量查询等方式消除。
- 长时间运行的查询 **应当** 通过慢查询日志识别，并通过索引或查询改写进行优化。

## 4. 缓存与限流

- 读多写少的接口在合适场景下 **应当** 使用缓存，并在缓存键中包含租户/站点范围信息。
- 限流行为 **必须** 遵循 API 与安全规范中定义的 Phase 1 / Phase 2 模型，Phase 2 目标为基于 Redis 的令牌桶算法。

## 5. PHP 运行时与 HTTP 层

- PHP-FPM（或等价实现）的工作进程数 **应当** 根据 CPU 核数和外部依赖延迟合理配置。
- 针对数据库、Redis、外部 HTTP 的超时 **必须** 显式配置。

## 6. 性能 Phase 模型

- **Phase 1（基线）**：识别并修复明显瓶颈，确保关键查询有正确索引，消除 N+1 问题。
- **Phase 2（目标）**：定义并监控 SLO，通过指标与链路追踪驱动持续性能优化。

