# 数据库设计规范

## 1. 范围与目标

本规范用于约束 AlkaidSYS 项目的关系型数据库设计与数据访问方式，是数据库相关工作的**唯一权威规范**，包括：表结构设计、多租户键、索引与查询优化、迁移与数据变更等。

- 所有新增数据库相关工作 **必须** 遵循本规范。
- 如与实现存在冲突，以本规范与 `design/03-data-layer/10-api-design.md` 的组合为准，禁止以“历史实现”为理由新增不一致设计。

## 2. 参考文档

- `design/03-data-layer/10-api-design.md`（数据层与 API 合同）
- `design/04-security-performance/11-security-design.md`（租户隔离与安全相关约束）
- `docs/todo/development-backlog-2025-11-23.md`（与迁移、BaseModel 作用域相关的 P1 任务）
- `docs/report/t1-domain-cleanup-s3-s4-execution-report.md`（Legacy 域清理执行报告）

## 3. 模式与命名规则

- 数据库、schema 与表名 **必须** 使用 `snake_case`。
- 表名 **必须** 使用复数名词，例如：`users`、`workflow_nodes`、`lowcode_collections`。
- 字段名 **必须** 使用 `snake_case`，且语义稳定，例如：`created_at`、`updated_at`、`tenant_id`、`site_id`。
- 主键字段 **应当** 使用名为 `id` 的 `BIGINT UNSIGNED` 自增列；仅在有充分理由并记录在案时才使用自然主键。
- 外键字段 **必须** 引用目标表主键（通常为 `id`），命名遵循 `<entity>_id` 规则。
- 使用软删除时 **必须** 使用可空的 `deleted_at` 字段表示删除时间。

## 4. 多租户与多站点隔离

- 所有存储租户级业务数据的表 **必须** 包含 `tenant_id` 字段；存在站点维度的数据 **必须** 额外包含 `site_id` 字段。
- 多租户约束 **必须** 体现为：
  - 主查询索引中包含 `tenant_id`（以及必要时的 `site_id`），而不是仅使用 `id`。
  - 逻辑上按租户唯一的约束 **必须** 在唯一索引中包含 `tenant_id`。
- 后端模型 **必须** 通过 `BaseModel` 的全局作用域自动附加 `tenant_id` / `site_id` 条件；
  - 直接使用查询构造器或原生 SQL 时 **必须** 显式添加同样的过滤条件。
- 数据层禁止跨租户访问；跨租户报表等需求 **必须** 通过专门的报表视图/服务实现，并经过安全评审。

## 5. 索引与查询优化

- 所有被频繁用于过滤、关联或排序的字段 **应当** 建立 B 树索引。
- 复合索引 **必须** 根据真实查询模式设计，通常以 `tenant_id` 开头，后跟选择性更高的业务键。
- 开发人员 **必须** 在预发/生产环境中使用查询计划与慢查询日志验证新功能的索引有效性。
- N+1 查询模式 **必须** 通过关联、预加载或批量查询等方式消除。
- 大文本/大对象字段 **禁止** 用于等值或范围过滤；如有复杂搜索需求 **应当** 使用专门的搜索基础设施。

## 6. 迁移与数据变更

- 所有结构性变更 **必须** 通过 `database/migrations/` 下的迁移文件引入，禁止在共享环境上直接执行手工 DDL。
- 每个迁移 **应当** 在技术可行的前提下保持幂等且可回滚。
- 包含数据回填或破坏性操作的迁移 **必须** 提供：
  - 明确的回滚或补救方案说明；
  - 覆盖典型数据形态的测试用例。
- 应用代码、迁移与设计文档 **必须** 保持一致；如故意偏离 **必须** 记录在 `docs/report/*` 中，并在存在后续工作时在 Backlog 中建项。

## 7. Legacy vs Low-code 数据模型

- `Domain\\Lowcode` 与 `Infrastructure\\Lowcode` 是低代码集合/字段定义的**唯一事实来源**。
- 新功能 **禁止** 引入对以下 Legacy 集合相关类的新依赖：
  - `Domain\\Model\\Collection`
  - `Infrastructure\\Collection\\CollectionManager`
  - `Infrastructure\\Field\\FieldTypeRegistry`
- 标记为废弃的 Legacy 表与字段 **只能** 用于兼容性适配层，不得承载新业务逻辑。
- 当低代码集合替代表时，迁移 **必须** 记录字段级映射规则及必要的数据迁移策略。

## 8. 数据层 Phase 模型

- **Phase 1（当前基线能力）**：
  - 现有表结构与部分迁移在修改时 **必须** 补齐本规范要求的命名及多租户约束。
  - 所有新建表/字段 **必须** 通过迁移创建，并从一开始就遵守本规范。
  - 低代码集合与关系表之间 **必须** 保持一致；强烈不建议新增脱离低代码模型的“零散表”。
- **Phase 2（目标能力）**：
  - 所有关键业务表 **应当** 拥有完整的正向/回滚迁移及必要的种子数据。
  - 已被低代码完全替代的 Legacy 表 **应当** 按照 T1 域清理执行报告和项目的主版本废弃策略逐步下线。
  - 结构演进与数据迁移 **应当** 通过自动化测试在 CI 中得到验证。

