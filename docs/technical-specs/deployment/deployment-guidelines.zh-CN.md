# 部署与运维规范

## 1. 范围与目标

本规范用于约束 AlkaidSYS 的部署与运维实践，重点关注配置管理、可观测性与运行时安全，是生产环境运维的**权威参考**，与 API 与安全规范互为补充。

## 2. 配置与环境

- 所有与环境相关的配置 **必须** 通过环境变量或纳入版本控制的配置文件提供（不包含机密信息）。
- 密钥（密码、Token、密钥等） **禁止** 提交到代码仓库；**应当** 使用专门的机密管理方案。
- 预发与生产环境的配置 **应当** 尽量保持一致，仅在终端地址、密钥和容量等方面存在差异。

## 3. 日志与可追踪性

- 所有服务 **必须** 输出结构化日志（JSON 或键值格式），至少包含时间戳、级别、消息、`trace_id` 以及可用时的租户/站点上下文。
- 应用日志级别 **必须** 可按环境配置。
- 通过 `X-Trace-Id` 传播的 Trace ID **必须** 写入日志，并在各服务之间保持可关联性。

## 4. 指标与健康检查

- 服务 **应当** 暴露与选用监控体系兼容的指标端点。
- 在编排环境中，存活探针与就绪探针 **必须** 实现并正确配置。
- 关键业务指标与错误率 **应当** 配置告警规则。

## 5. 缓存、会话与队列

- 缓存、会话和队列（在适用场景下）**必须** 统一使用 Redis（或等价方案）作为后端。
- 针对租户级数据的缓存键 **应当** 包含租户/站点信息。
- 队列消费者 **必须** 配置安全的重试与退避策略；应当 定义异常消息的处理方案（例如死信队列）。

## 6. 部署流程

- 生产环境部署 **必须** 通过 CI/CD 实现自动化且可复现。
- 每次部署 **应当** 关联到唯一的 Git 提交与构建产物。
- 回滚流程 **必须** 被文档化，并在非生产环境中定期演练。

## 7. 运维 Phase 模型

- **Phase 1（基线能力）**：
  - 已具备基础日志和环境配置；可以通过人工操作完成回滚。
- **Phase 2（目标能力）**：
  - 具备完整的可观测性（日志、指标、链路追踪）与告警；部署失败时具备自动回滚能力。

