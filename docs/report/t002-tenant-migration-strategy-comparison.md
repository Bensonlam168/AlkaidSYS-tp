# T-002（P1）低代码 Collection 多租户数据迁移策略对比报告

> 本报告面向产品、运营和业务负责人，尽量避免技术细节，用业务语言说明两种迁移策略的差异与影响。

- 目标任务：为 `lowcode_collections` 表引入 `tenant_id` / `site_id`，并选择**如何接住现有数据**。
- 两种备选策略：
  - **策略 A：系统模板（`tenant_id = 0`）**
  - **策略 B：归属运维租户（所有历史数据挂到某个“运维专用租户”）**

---

## 一、使用场景分析

### 1. 策略 A：系统模板（tenant_id = 0）

#### 1.1 适用的业务场景和用户故事

- **场景 1：平台预置一批“官方表单/数据结构模板”**
  - 平台方（产品/运营）设计了一套标准的业务表单、数据结构（如“客户信息”、“线索收集”、“工单”等）。
  - 这些模板不是某一个具体租户的资产，而是**平台级资产**，可以被多个租户复用。
  - 租户在开通时，可以从“官方模板库”中选择一部分模板，一键复制到自己的空间并进行定制。

- **场景 2：SaaS 平台希望逐步从“项目型交付”转向“产品化模板交付”**
  - 早期：很多低代码建模结果是按项目/客户定制的，很难复用。
  - 现在：需要把通用价值提炼成“平台官方模板库”，新客户上来直接选用，交付周期更短，更标准化。
  - 策略 A 自然提供了“系统模板层”，支持未来逐步沉淀模板。

- **场景 3：多租户+多业务线，希望统一风格但给予差异化空间**
  - 总部/集团希望定义一套统一的表单结构与字段命名规范。
  - 各子公司/租户在此基础上可新增字段或小范围调整，而不会影响“总部模板”。

#### 1.2 典型工作流程示例

> 用户故事：新租户 A 入驻平台，希望快速搭建一套“客户管理”功能。

1. 产品/运营在“系统模板空间（tenant_id=0）”中预置：`客户表单模板`、`跟进记录模板` 等。
2. 新租户 A 开通时：
   - 在“模板中心”看到平台预置模板列表。
   - 选择“客户管理”模板，一键复制到自己的租户空间（真正的业务表会带上 A 的 `tenant_id`）。
3. 复制完成后：
   - A 租户可以在自己的租户空间内自由调整字段，不会影响系统模板，也不会影响其他租户。
4. 将来新租户 B 入驻时，可以直接复用同一批系统模板，但不会与 A 互相干扰。

#### 1.3 对最终用户的影响

- 对于租户管理员/业务配置人员：
  - 好处：
    - 一上来就有一批“可用模板”，不需要从 0 开始搭建。
    - 可以在自己的租户内安全地修改和扩展，不会破坏系统级模板。
  - 体验：
    - 看到的是“模板中心 + 自己的空间”，思路清晰：
      - 模板中心：可选/可复制，不可直接改动（或有受限改动）。
      - 自己的空间：完全可编辑。

- 对于普通业务用户（表单填写/数据使用者）：
  - 只会接触到**本租户实例化后的表单和数据**，不会感知系统模板层。
  - 体验稳定：各租户之间没有“看见对方表单/数据”的风险。

#### 1.4 对系统管理员的影响

- 平台管理员：
  - 获得一层清晰的“系统模板层”，可以：
    - 统一维护一套“官方模板库”。
    - 区分“模板是否只影响未来新租户”还是“是否要提供迁移/升级手段影响存量租户”。
  - 运维/审计视角更简单：
    - 系统模板（tenant_id=0）可以单独审计、备份、版本管理。

- 风险控制：
  - 系统模板层默认不直接被业务租户使用为“生产表”，避免“一个租户改坏表单导致所有租户出问题”的情况。

---

### 2. 策略 B：归属运维租户

#### 2.1 适用的业务场景和用户故事

- **场景 1：平台内部只有一组“运维/实施团队”在统一维护所有客户的模型**
  - 所有低代码配置都由内部实施团队完成，不对各租户开放自助配置能力。
  - 实施团队希望在“自己的运维租户”下看到全部表单和模型，集中管理。

- **场景 2：平台暂时不打算做“模板中心”这一层**
  - 产品形态更偏向“项目型交付”：
    - 每个项目/客户的模型都由实施团队单独维护。
    - 不强调跨客户复用模板。
  - 此时，把历史数据全部收束在一个运维租户，看起来更接近“现在的工作习惯”。

#### 2.2 典型工作流程示例

> 用户故事：实施顾问在运维租户中为某客户配置表单。

1. 实施顾问登录“运维租户”，在其中配置或调整 `lowcode_collections`。
2. 对具体客户的业务数据访问，仍通过各自租户的业务表实现，但元数据都集中保存在运维租户名下。
3. 当客户提出修改需求时，实施顾问在运维租户下改动模型，然后通过某种“发布机制”让改动生效到客户环境（需要额外流程支撑）。

#### 2.3 对最终用户的影响

- 对租户管理员/业务配置人员：
  - 如果平台不开放自助配置：
    - 体验与现在差别不大，仍然依赖实施团队“黑盒式”交付。
  - 如果未来要开放自助配置：
    - 租户可能会困惑：
      - “我的表单到底属于谁？是我的租户，还是那个运维租户？”
      - 权限、审计和变更责任边界不清晰。

- 对普通业务用户：
  - 一般情况下感知不到差异，但在问题排查时，追溯“表单是谁改坏的”会更复杂（运维租户统一修改）。

#### 2.4 对系统管理员的影响

- 运维/实施团队：
  - 好处：
    - 所有模型集中在一个“超级租户”下，便于统一查看和管理。
  - 问题：
    - 多租户隔离概念变得含糊：
      - 技术上数据都挂在运维租户，但逻辑上又分别属于不同客户/租户。
      - 审计和合规上不够清晰。

---

## 二、与设计文档的契合度分析

> 参考：`docs/todo/低代码 Collection 多租户改造多阶段路线.md` 的 P1 目标，以及设计目录中关于多租户隔离、低代码扩展性和阶段演进的要求。

### 1. 多租户隔离原则

- **策略 A**：
  - 清晰区分三种层级：
    - 系统模板层（tenant_id=0）；
    - 各业务租户层；
    - 未来可能的站点层（site_id）。
  - 有利于严格落实“不同租户的业务模型和数据必须隔离”的原则：
    - 模型本身按租户实例化，数据天然带租户维度。

- **策略 B**：
  - 从物理上看，所有历史模型都挂在一个“运维租户”下，与真实业务租户存在“所有权错位”。
  - 对外宣称多租户隔离，但在**模型层**实际上存在“集中所有权”，合规和审计复杂度更高。

### 2. 低代码框架的扩展性要求

- **策略 A**：
  - 自然支持“模板 → 实例”的扩展模式：
    - 模板库可以逐步丰富。
    - 后续可以增加模板版本、灰度发布、按租户选择是否升级。
  - 与“低代码+多租户”的典型产品形态高度契合：平台沉淀可复用资产，每个租户在此基础上扩展。

- **策略 B**：
  - 更像“一大坨配置全部集中在一个超级租户里”，对未来的模板化、分层发布、灰度控制都不友好。
  - 一旦要支持“租户自助配置”，现有模型必须从运维租户“搬家”到各个实际租户，成本较高。

### 3. 向后兼容性考虑

- 设计文档要求 P1 阶段在不破坏现有功能的前提下引入多租户语义：
  - 历史数据要“有去处”；
  - 同时为 P2/P3 的进一步演进留接口。

- **策略 A**：
  - 历史数据统一标记为 `tenant_id=0`，短期内等价于“全局行为未变”，兼容性好。
  - 未来如果需要把历史模型分配给具体租户，可以采用“从系统模板复制到租户”的方式，逐步迁移。

- **策略 B**：
  - 历史数据全部归到运维租户，对当前行为也兼容；
  - 但后续一旦要区分“模板 vs 实例”，需要增加一次大规模迁移，把模型重新按租户或模板维度拆分，演进成本更高。

### 4. 对未来 P2/P3 演进路径的支撑

- **策略 A** 更贴近设计文档中“分阶段演化”的路线：
  - P1：先加上模板层和租户字段，保证每条记录有清晰的 tenant 标记（系统级=0）。
  - P2：在业务数据表层面引入多租户隔离与模板复制逻辑。
  - P3：进一步做模板版本、租户差异化定制、权限/审计等高级能力。

- **策略 B**：
  - 后续如果要引入模板中心、租户自助配置，改造路线会相对“逆向”：
    - 先要从运维租户剥离出模板概念；
    - 再把模板和具体租户实例区分开来；
    - 演进路径会比策略 A 更曲折。

---

## 三、优缺点对比表

| 维度 | 策略 A：系统模板（tenant_id=0） | 策略 B：归属运维租户 |
| --- | --- | --- |
| 业务优势 | 提供清晰的“平台模板库”，利于标准化交付和复用；租户只需在模板基础上二次配置 | 短期内贴近“集中由实施团队维护”的现有习惯，便于运维团队统一视图 |
| 业务劣势/限制 | 需要在产品层面设计“模板中心”和“从模板复制”的流程，对产品设计有一定要求 | 多租户边界模糊，后续要支持模板化/自助配置时，需要额外的大规模拆分改造 |
| 对现有数据的影响 | 现有数据被视为系统模板，不直接暴露给具体租户使用，需通过“复制为租户实例”接入正式业务 | 现有数据直接挂在运维租户名下，继续作为“统一维护的模型”，但与真实租户业务之间的映射不直观 |
| 对租户体验的影响 | 新租户可以从官方模板库快速搭建，自助能力更强；长期来看更贴近标准 SaaS 使用体验 | 如不开放自助配置，短期体验变化不大；一旦开放自助，则租户难以理解“表单真正归属”与变更边界 |
| 系统管理员视角 | 清晰区分系统模板与各租户实例，易于审计、版本管理和变更控制 | 一切都在运维租户下，管理集中但职责边界不清晰，审计合规压力更大 |
| 未来扩展灵活性 | 非常适合后续增加模板版本、灰度发布、按租户选择是否升级等高级能力 | 后续扩展需要先“解耦”运维租户与业务租户关系，整体演进路径更长、更复杂 |

---

## 四、决策建议

### 1. 推荐方案

综合使用场景和设计文档的长期规划，**推荐采用策略 A：系统模板（tenant_id=0）**。

### 2. 推荐理由（业务视角）

1. **符合“平台化 + 模板化交付”的长期方向**
   - 策略 A 鼓励我们把现有配置沉淀为“平台级模板资产”，而不是继续停留在“项目型、客户单点”的交付模式。
   - 方便未来做出“模板中心”、“模板版本管理”、“一键为新租户装配模板”等产品能力。

2. **多租户边界清晰，易于与客户沟通和合规审计**
   - 可以很清楚地向客户解释：
     - 系统模板：平台方的统一标准，不直接属于任何一个业务租户；
     - 租户实例：每个租户基于模板复制出的自己的模型和数据，只属于该租户。
   - 在审计/合规场景（尤其是大客户）下，这种边界更容易被接受和说明。

3. **为后续 P2/P3 能力预留足够空间，减少未来大改动**
   - 策略 A 的设计直接对齐文档中“分阶段演进”的路线，后续迭代更多是“在既有分层模型上加能力”，而不是推翻重来。
   - 可以逐步、平滑地引入高级能力，而不是在某个阶段被迫做一次“大迁移”。

4. **现阶段实现成本可控，短期行为与现状接近**
   - 将历史数据标记为 `tenant_id=0` 后，短期内与“全局表”的行为非常接近，不会突然改变现有功能表现。
   - 真正的“租户实例化”和模板复制可以在后续任务中分批引入，不必一次性完成。

### 3. 建议由产品/业务确认的关键决策点

在落地策略 A 之前，建议与产品/业务团队对齐以下问题：

1. **系统模板的可见性与操作权限**
   - 系统模板是否只对平台方内部可见？
   - 是否允许某些高阶租户管理员查看或基于系统模板创建自有模板？

2. **模板复制与升级策略**
   - 新租户开通时，哪些模板会被默认复制？
   - 模板后续升级时：
     - 是否只影响新租户？
     - 是否提供“为已存在租户推送升级”的能力？

3. **租户实例化流程在产品中的呈现方式**
   - 前端是否需要一个“模板中心”或“应用市场”式的入口？
   - 复制模板为租户实例时，是否允许租户对字段做自由修改？

4. **系统模板与租户自定义模板的区分**
   - 是否允许租户将自己的模型“上升”为平台模板（由平台审核后入库）？
   - 在权限和责任边界上如何区分“系统模板问题”和“某租户自定义配置导致的问题”？

---

## 五、小结

- 两种策略在“技术上都可行”，但从**产品形态和长期演进**来看：
  - 策略 A 更适合作为一条清晰且可持续的演进路线，能够支撑未来 P2/P3 的低代码能力建设；
  - 策略 B 更偏向短期、项目型交付思路，长期看会增加“脱胎换骨”的难度。
- 因此，本报告建议：
  - **技术方案默认采用策略 A（系统模板 tenant_id=0）**；
  - 在此基础上，由产品/业务团队进一步明确“模板中心”和“模板复制/升级”的业务规则，并纳入后续迭代计划。
